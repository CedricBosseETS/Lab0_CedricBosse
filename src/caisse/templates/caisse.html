<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Caisse</title>
    <style>
        body { font-family: sans-serif; padding: 1rem; }
        input[type="number"] { width: 3rem; }
        button { margin-left: 0.5rem; }
        select, input, button { margin: 0.25rem 0; }
    </style>
<script>
    // ---------------------------------------------------------
    // Variables & utilitaires
    // ---------------------------------------------------------
    const magasinId = "{{ magasin_id }}";
    function getCookie(name) {
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? v.pop() : '';
    }

    // ---------------------------------------------------------
    // Tout ce qui manipule le DOM doit attendre que le DOM soit pr√™t
    // ---------------------------------------------------------
    window.addEventListener('DOMContentLoaded', () => {
        // Chargement du nom du magasin
        (async () => {
            try {
                const res = await fetch(`/api/magasins/${magasinId}/`, { credentials: 'include' });
                if (!res.ok) throw new Error('Impossible de charger le magasin');
                const m = await res.json();
                document.getElementById('nom-magasin').textContent = m.nom;
            } catch (e) {
                console.error(e);
            }
        })();

        // Affichage du stock
        async function fetchStocks() {
            const ul = document.getElementById('liste-produits');
            ul.innerHTML = '<li>Chargement‚Ä¶</li>';
            try {
                const res = await fetch(`/api/stocks/?magasin_id=${magasinId}`, { credentials: 'include' });
                if (!res.ok) throw new Error('Erreur chargement stocks');
                const stocks = await res.json();
                ul.innerHTML = stocks.length === 0
                    ? '<li>Aucun produit en stock</li>'
                    : '';
                for (const s of stocks) {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        ${s.produit.nom} ‚Äî Stock: ${s.quantite}
                        <input type="number" id="stock-qte-${s.produit.id}" min="1" value="1">
                        <button data-produit="${s.produit.id}">Ajouter</button>
                    `;
                    li.querySelector('button').addEventListener('click', () => {
                        ajouterAuPanier(s.produit.id, `stock-qte-${s.produit.id}`);
                    });
                    ul.appendChild(li);
                }
            } catch (err) {
                ul.innerHTML = `<li>Erreur : ${err.message}</li>`;
            }
        }

        // Ajouter au panier
        function ajouterAuPanier(produitId, qteInputId) {
            const quantite = parseInt(document.getElementById(qteInputId).value, 10);
            fetch(`/api/panier/${magasinId}/ajouter/`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ produit_id: produitId, quantite })
            })
            .then(res => res.ok
                ? res.json()
                : res.json().then(e => Promise.reject(e.error || 'Erreur')))
            .then(() => alert('Produit ajout√© au panier'))
            .catch(err => alert('Erreur : ' + err));
        }

        // Recherche de produits
        document.getElementById('recherche-form').addEventListener('submit', async e => {
            e.preventDefault();
            const q = document.getElementById('search').value.trim();
            const ul = document.getElementById('resultats');
            ul.innerHTML = '<li>Chargement‚Ä¶</li>';
            try {
                const res = await fetch(`/api/produits/?search=${encodeURIComponent(q)}&magasin_id=${magasinId}`, {
                    credentials: 'include'
                });
                if (!res.ok) throw new Error('Erreur chargement');
                const produits = await res.json();
                ul.innerHTML = produits.length
                    ? produits.map(p => `
                        <li>
                            ${p.nom} ‚Äî ${p.prix} $
                            <input type="number" id="qte-${p.id}" min="1" value="1">
                            <button onclick="ajouterAuPanier(${p.id}, 'qte-${p.id}')">Ajouter</button>
                        </li>`).join('')
                    : '<li>Aucun produit trouv√©.</li>';
            } catch (err) {
                ul.innerHTML = `<li>Erreur : ${err.message}</li>`;
            }
        });

        // Bouton Afficher les produits
        document.getElementById('btn-afficher-produits')
            .addEventListener('click', fetchStocks);

        // R√©approvisionnement
        document.getElementById('reappro-form').addEventListener('submit', async e => {
            e.preventDefault();
            const payload = {
                destination_magasin_id: magasinId,
                produit_id: parseInt(document.getElementById('produit-select').value, 10),
                quantite: parseInt(document.getElementById('quantite-input').value, 10)
            };
            try {
                const res = await fetch(`/api/maison_mere/${magasinId}/approvisionner/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                const msgEl = document.getElementById('reappro-message');
                if (res.ok) {
                    msgEl.innerHTML = `<p style="color:green;">R√©approvisionnement OK</p>`;
                    await fetchStocks();
                } else {
                    msgEl.innerHTML = `<p style="color:red;">Erreur : ${data.error || '√âchec'}</p>`;
                }
            } catch (err) {
                document.getElementById('reappro-message').innerHTML =
                    `<p style="color:red;">Erreur r√©seau</p>`;
            }
        });

        // Historique des ventes
        document.getElementById('ventes-container').innerHTML = '';
        document.querySelector('button[onclick="afficherVentes()"]')
            .addEventListener('click', async () => {
                const cont = document.getElementById('ventes-container');
                cont.innerHTML = '<p>Chargement‚Ä¶</p>';
                try {
                    const res = await fetch(`/api/magasins/${magasinId}/ventes/`, { credentials: 'include' });
                    if (!res.ok) throw new Error('Erreur');
                    const ventes = await res.json();
                    cont.innerHTML = ventes.length
                        ? '<ul>' + ventes.map(v => {
                            const prods = v.produits.map(p => `${p.nom}√ó${p.quantite}`).join(', ');
                            return `<li>
                                Vente #${v.id} ‚Äì ${v.date} ‚Äì Total : ${v.total} $ ‚Äì ${prods}
                                <button onclick="annulerVente(${v.id})">Annuler</button>
                            </li>`;
                        }).join('') + '</ul>'
                        : '<p>Aucune vente enregistr√©e</p>';
                } catch (e) {
                    cont.innerHTML = `<p style="color:red;">Erreur : ${e.message}</p>`;
                }
            });
    });

    // Fonction globale pour annuler une vente (reste hors du DOMContentLoaded)
    function annulerVente(id) {
        if (!confirm("Annuler la vente ?")) return;
        fetch(`/api/magasins/${magasinId}/ventes/${id}/annuler/`, {
            method: 'DELETE',
            credentials: 'include',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(res => res.ok ? window.location.reload() : alert("√âchec annulation"));
    }
</script>

</head>
<body>
    <a href="/">üè† Accueil</a>
    <h1>Caisse pour le magasin <span id="nom-magasin">‚Ä¶</span></h1>

    <h2>Recherche de produit</h2>
    <form id="recherche-form">
        <input type="text" id="search" placeholder="Nom ou ID du produit" required>
        <button type="submit">Rechercher</button>
    </form>
    <ul id="resultats"></ul>

    <h2>Produits disponibles</h2>
    <button id="btn-afficher-produits">Afficher les produits en stock</button>
    <ul id="liste-produits"></ul>
    <button onclick="location.href='/panier/'+magasinId+'/';">Voir mon panier</button>

    <h2>R√©approvisionnement depuis le centre logistique</h2>
    <form id="reappro-form">
        <label>Produit :</label>
        <select id="produit-select" required>
            <option value="" disabled selected>Choisir un produit</option>
            {% for produit_id, stock in stock_centre.items %}
                <option value="{{ produit_id }}">
                    {{ stock.produit.nom }} ({{ stock.quantite }} en stock)
                </option>
            {% endfor %}
        </select>
        <label>Quantit√© :</label>
        <input id="quantite-input" type="number" min="1" required>
        <button type="submit">Transf√©rer</button>
    </form>
    <div id="reappro-message"></div>

    <h2>Historique des ventes</h2>
    <button onclick="afficherVentes()">Afficher les ventes</button>
    <div id="ventes-container"></div>
</body>
</html>
