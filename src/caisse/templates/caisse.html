<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Caisse</title>
    <style>
        /* m√™mes styles que l‚Äôancienne page */
    </style>
</head>
<body>

<a href="/">üè† Accueil</a>
<h1>Caisse pour le magasin <span id="nom-magasin">...</span></h1>

<!-- Bouton pour afficher les produits -->
<button id="btn-afficher-produits">Afficher les produits</button>

<!-- Conteneur des produits -->
<h2>Produits disponibles</h2>
<ul id="liste-produits">
    <!-- Rempli dynamiquement -->
</ul>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const magasinId = "{{ magasin_id }}";

        // Charger nom du magasin
        const magasinResp = await fetch(`/api/magasins/${magasinId}/`);
        const magasin = await magasinResp.json();
        document.getElementById("nom-magasin").textContent = magasin.nom;

        // G√©rer bouton "Afficher les produits"
        const btnAfficher = document.getElementById("btn-afficher-produits");
        btnAfficher.addEventListener("click", async () => {
            const ul = document.getElementById("liste-produits");
            ul.innerHTML = ""; // vider la liste

            const resp = await fetch(`/api/stocks/?magasin_id=${magasinId}`);
            const stocks = await resp.json();

            if (stocks.length === 0) {
                ul.innerHTML = "<li>Aucun produit en stock</li>";
            } else {
                stocks.forEach(stock => {
                    const li = document.createElement("li");
                    li.textContent = `${stock.produit.nom} ‚Äî Quantit√©: ${stock.quantite}`;
                    ul.appendChild(li);
                });
            }
        });
    });
</script>
<h2>R√©approvisionnement depuis le centre logistique</h2>

<form id="reappro-form">
    <label for="produit-select">Produit :</label>
    <select id="produit-select" name="produit_id" required>
        <option value="" disabled selected>Choisir un produit</option>
        {% for produit_id, stock in stock_centre.items %}
            <option value="{{ produit_id }}">
                {{ stock.produit.nom }} ({{ stock.quantite }} en stock)
            </option>
        {% endfor %}
    </select>

    <label for="quantite-input">Quantit√© :</label>
    <input id="quantite-input" type="number" name="quantite" min="1" required />

    <button type="submit">Transf√©rer</button>
</form>

<div id="reappro-message"></div>

<script>
    const form = document.getElementById('reappro-form');
    const messageDiv = document.getElementById('reappro-message');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const produitId = document.getElementById('produit-select').value;
        const quantite = document.getElementById('quantite-input').value;

        messageDiv.textContent = '';

        try {
            const response = await fetch(`/api/magasins/{{ magasin.id }}/reapprovisionner/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ produit_id: produitId, quantite: quantite }),
            });

            const data = await response.json();

            if (!response.ok) {
                messageDiv.textContent = "Erreur : " + (data.error || "Erreur inconnue");
                messageDiv.style.color = 'red';
            } else {
                messageDiv.textContent = data.success;
                messageDiv.style.color = 'green';
                form.reset();
                // Optionnel : reload page ou mettre √† jour l'affichage du stock
                // location.reload();
            }
        } catch (err) {
            messageDiv.textContent = "Erreur : " + err.message;
            messageDiv.style.color = 'red';
        }
    });

    // Fonction pour r√©cup√©rer le CSRF token (m√™me que pr√©c√©demment)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                const cookie = c.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

</body>
</html>
